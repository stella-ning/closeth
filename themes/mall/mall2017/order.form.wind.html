{include file=top2017.html}
<link type="text/css" href="{res file=css/order3.css}" rel="stylesheet" />
<script type="text/javascript" src="{lib file=mlselection.js}" charset="utf-8"></script>
<script type="text/javascript" src="{lib file=jquery.plugins/jquery.validate.js}" charset="utf-8"></script>
<script type="text/javascript" src="{lib file=dialog/dialog.js}" id="dialog_js" charset="utf-8"></script>
<script type="text/javascript" src="index.php?act=jslang"></script>
<script type="text/javascript" src="{lib file=ecmall.js}" charset="utf-8"></script>
<script type="text/javascript" src="{lib file=cart.js}" charset="utf-8"></script>
<script type="text/javascript" src="{lib file=layer/layer.js}" charset="utf-8"></script>
<script type="text/javascript" src="{res file=js/formValid.js}" charset="utf-8"></script>
<script type="text/javascript">
//<!CDATA[

//]]>
</script>
<script>
var checkSubmitflag = false;

function checkSubmit(){
    if(checkSubmitflag == true){
        return false;
    }
    checkSubmitflag = true;
    return true;

}
</script>
<style>
    #address_form>ul>li>p>input{border:1px solid #ccc;}
    .width_normal {width: 195px;}
</style>
<!--  个人中心 -->
<div id="headear">
    <h1 title="{$lang.w_title}">
        <a href="index.php"><img src="{$site_url}/static/app/android/240x90.png" alt="{$lang.w_title}"></a>
    </h1>
    <div id="path">
        <div class="path-font">{$lang.qrdd}</div>
    </div>
    <!-- 流程 -->
    <div class="order-step">
        <dl class="ready">
            <dt>
                下单
            </dt>
            <dd><i class="vvicon"></i></dd>
            <dd class="step-number">1</dd>
        </dl>
        <dl>
            <dt>
                {$lang.pay}
            </dt>
            <dd><i class="vvicon"></i></dd>
            <dd class="step-number">2</dd>
        </dl>
        <dl>
            <dt>
                拿货
            </dt>
            <dd><i class="vvicon"></i></dd>
            <dd class="step-number">3</dd>
        </dl>
        <dl>
            <dt>
                发货
            </dt>
            <dd><i class="vvicon"></i></dd>
            <dd class="step-number">4</dd>
        </dl>
    </div>

</div>
<!--  个人中心 -->
<style>
    .fill_in_content .select_box{
    display:none;
    }
    .select_box{
        display:none;
    }
    #region1 select{
        height: 25px;
        margin-top: 7px;
        border: 1px solid #ebebeb;
    }
    .field_message{
            
        color: #9c9c9c;
    }
    .o-font{
        color: #f07;
        font-weight: bolder;
    }
    #warning {border:red 1px solid; background:#FFB7B7; color:#000; padding:3px 10px; margin:8px 0px; display:none; color:#000; font-weight:normal;}
    #warning label {display:block; margin:3px 0px;}
    #warning label.error {color:#000; font-weight:normal;}
    fieldset.o-address .item select{
        display:inline-block !important;
    }
    fieldset.o-address .item select.error{
        float:none !important;
        margin:0;
    }
    .valid_message{
        display:block;
        color:red;
    }
    #orderDetail .pl36{
        padding-left:22px;
    }
    #orderDetail .w200{
        width:275px;
        text-align:center;
    }
    #orderDetail .mt3{
        margin-top:15px;
    }

</style>


<div class="order" id="confirmOrder">
    <form method="post" id="order_form"  onsubmit="return checkSubmit();">
        <!--    地址选择/填写     -->
        <div class="o-box">
            <!--{if $my_address}-->
            <div class="newsAddress">
                <section  id="address_form">
                    <div class="o-box-t selected" data-type="add">
                        <i class="vvicon close"></i><i class="vvicon open"></i> 填写收货地址
                    </div>
                    <!-- 填写地址表单 -->
                    <div class="o-box-main writeNewAddres" style="height: auto;">
                        <div id="witeNewAddWrap">
                            <fieldset class="o-address" style="padding: 20px 0;">
                                <div class="item clearfix">
                                    <label><span style="color:#ef3664;padding-right:5px;">*</span>所在地区：</label>
                                    <div id="region1">
                                        <input type="hidden" name="region_id" value="<?php echo $this->_var['address']['region_id']; ?>" id="region_id" class="mls_id" />
                                        <input type="hidden" name="region_name" id="region_name" value="<?php echo htmlspecialchars($this->_var['address']['region_name']); ?>" class="mls_names" />
                                            <?php if ($this->_var['address']['region_id']): ?>
                                        <span><?php echo htmlspecialchars($this->_var['address']['region_name']); ?></span>
                                        <input type="button" value="编辑" class="edit_region" />
                                        <select style="display:none"  class="required" data-valid="isNonEmpty" date-tip = "" data-error="请选择地区">
                                            <option value=''>请选择...</option>
                                              <?php echo $this->html_options(array('options'=>$this->_var['regions'])); ?>
                                        </select>
                                            <?php else: ?>
                                        <select  class="required" data-valid="isNonEmpty" date-tip = "" data-error="请选择地区">
                                            <option value=''>请选择...</option>
                                              <?php echo $this->html_options(array('options'=>$this->_var['regions'])); ?>
                                        </select>
                                            <?php endif; ?>
                                    </div>
                                </div>

                                <div class="item clearfix">
                                    <label><span style="color:#ef3664;padding-right:5px;">*</span>详细地址：</label>
                                    <span class="form_group">
                                        <textarea name="address" id="address" class="required input-address j-input-address"  value="<?php echo htmlspecialchars($this->_var['address']['address']); ?>" cols="30"
                                              rows="10" data-valid="isNonEmpty" date-tip = "" data-error="请填写详细地址"></textarea>
                                    </span>
                                    
                                </div>
                               
                                <div class="item clearfix">
                                    <label><span style="color:#ef3664;padding-right:5px;">*</span>收货人：</label>
                                    <span class="form_group">
                                        <input type="text" name="consignee" id="consignee" class="required" data-valid="isNonEmpty" data-tip="" data-error="请填写收货人" value="<?php echo htmlspecialchars($this->_var['address']['consignee']); ?>">
                                    </span>
                                    
                                    <span class="desc"><span class="red">注：</span>请填写真实姓名，否则部分快递拒绝收件</span>
                                </div>
                                <div class="item clearfix">
                                    <label><span style="color:#ef3664;padding-right:5px;">*</span>手机号码：</label>
                                    <span class="form_group">
                                        <input type="text" name="phone_mob" id="mobile"  value="<?php echo $this->_var['address']['phone_mob']; ?>"  class="input-mobile required" placeholder="手机号码"
                                        data-valid="isNonEmpty||isMobile" date-tip = "请输入您的手机号码" data-error="请输入您的手机号码||请输入合法手机号码">
                                         <label class="label-tel">固定号码：</label>
                                        <input type="text" name="phone_tel" id="tel1" class="input-tel j-tels j-tel-1" placeholder="固定电话号码" value="<?php echo $this->_var['address']['phone_tel']; ?>">
                                        <input type="hidden" class="j-tel add-rule" id="tel" name="tel">
                                    </span>
                                </div>
                               
                                <div class="clear"></div>
                            </fieldset>

                            <div class="o-match">
                                <p>粘贴淘宝收货地址：</p>
                                <p>
                                    <textarea style="margin-top:5px;" class="long-address" id="matchAddress" cols="30" rows="10"
                                              rows="4" placeholder="例如: 小明 ，13888888888 ，022-57888888 ，天津 天津市 东丽区 撕浙殊徐球路隔误西街999号北区99栋909 ，300000" type="textarea" class="text width_normal" name="taobao_address" value=""></textarea>
                                </p>
                                <p class="desc">操作指引：粘贴淘宝「订单详情」的收货地址到输入框内，自动帮您填写地址，若匹配失败，请手动完善地址</p>
                            </div>
                        </div>
                        
                    </div>
                </section>
            </div>
            <!--{/if}-->
            <!--{if $my_address}-->
            <div class="used">
                <div class="o-box-t" data-type="select" style="margin-top: 1px;">
                    <i class="vvicon close"></i><i class="vvicon open"></i> 常用收货地址
                </div>
                <!-- 常用地址表单 -->
                <div class="o-box-main usedAddress" style="display: none;">
                    <div class="address-list clearfix" id="addressList">
                       
                        <ul class="clearfix">
                            <!--{foreach from=$my_address item=address name=address_select}-->
                                <li class="address_item">
                                    <label for="address_{$address.addr_id}">
                                        <dl>
                                            <dt class="address_consignee">{$address.consignee|escape}</dt>
                                            <dd>
                                                <p class="address-full">
                                                    <span class="address_region_name">{$address.region_name|escape}</span>
                                                    <span class="address_address">{$address.address|escape}</span>
                                                </p>
                                                
                                                <p>
                                                    <span class="address_phone_mob"> {$address.phone_mob}</span>&nbsp;&nbsp;&nbsp;&nbsp;
                                                    <span class="address_phone_tel">{$address.phone_tel}</span>
                                                </p>
                                                <a href="javascript:;" class="address-edit" data-url = "index.php?app=my_address&act=edit&addr_id={$address.addr_id}">修改</a>
                                            </dd>

                                            <dd class="default-info" style="display:none;">默认地址</dd>

                                            <dd class="selected-icon"><i class="vvicon"></i></dd>
                                        </dl>
                                        <input id="address_{$address.addr_id}" class="radioCheck" type="radio" name="address_options" value="{$address.addr_id}" style="opacity:0"/>
                                    </label>
                                </li>

                            <!--{/foreach}-->
                            <!-- <li class="add">
                                <a href="javascript:;" data-url="index.php?app=my_address&act=add" class="add" id="addAddress">
                                    <i class="vvicon"></i>
                                    <span>添加收货地址</span>
                                </a>
                            </li> -->
                           
                        </ul>
                    </div>
                </div>
            </div>
           
            <!--{/if}-->
        </div>
        <!-- 配送方式 -->
        <div id="select-shipping" class="o-box">
            <div class="o-box-t">
                配送方式   
            </div>
            <div class="shippingList behalfChose">
                <label class="label">选择代发：</label>
                <span class="required radio form-control " data-valid="isChecked" data-error="请选择代发" data-type="radio" style="border:none;box-shadow:none;">
                    <!--{foreach from=$behalfs item=behalf name=behalf_fee}-->
                    <label class="radio-wrap">
                        <span class="radio-inner-wrap">
                            <input type="radio" id="address_{$address.addr_id}" name="behalf" value="{$behalf.bh_id}" {if $smarty.foreach.behalf_fee.first} checked="checked" {/if}>
                            <span class="radio-inner"></span>
                        </span>
                        <span class="text">{$behalf.bh_name}</span>
                    </label>
                    <!--{/foreach}-->   
                </span>
                <input type="hidden" name="shipping_choice" value="{if $smarty.get.shipping_choice eq '1'}1{else}2{/if}"/>
            </div>
            <div class="shippingList deliveryChose" id="shipping_choice1">
                  <!--{if $shipping_methods}-->
                 <!-- 合入开始 -->
                <div class="fashion_list" ectype="logist_fees">
                      <!--{foreach from=$shipping_methods item=logist key=key name=fe_logist}-->
                       <ul class="receive_add shipping_item">
                          <li>
                            <label>
                            <input style="width:45px; text-align:center" class="mb5" type="radio" name="logist_fees" value="{$key}:{$logist.logist_fees}" {if $smarty.foreach.fe_logist.first} checked="checked"{/if} />{$lang.$key}{$lang.colon}{$logist.logist_fees|price}</label>
                        </li>
                       </ul>
                      <!--{/foreach}-->
                      <div class="mt10 pl20">{$lang.dangkou_ship}</div>
                </div>
                <!-- 合入结束 -->      
                <!--{/if}-->
                <label class="label">选择快递：</label>
                <span class="required radio form-control " id="delivery_area" data-valid="isChecked" data-error="请选择快递" data-type="radio" style="border:none;box-shadow:none;">
                    <!--{foreach from=$deliverys item=delivery name=delivery_fee}-->
                    <label class="radio-wrap">
                        <span class="radio-inner-wrap">
                            <input type="radio" name="delivery" value="{$delivery.dl_id}" fee="{$delivery.dl_fee}" {if $smarty.foreach.delivery_fee.first} checked="checked" {/if}>
                            <span class="radio-inner"></span>
                        </span>
                        <span class="text">
                            {$delivery.dl_name}(
                                <span class="price {if $vip_info}e60{/if}">{$delivery.dl_fee|price}</span>
                            )
                            {if $vip_info}<i class="vip{$vip_info.lv} pointer" title="vip等级{$vip_info.lv}，每单优惠{$vip_info.fee}元"></i>{/if}
                        </span>
                    </label>
                    <!--{/foreach}--> 
                </span>

            </div>

            <!-- 代发信息 -->
            <!--{if $behalfs}-->
            <section class="behalfInfo">
                <p class="title">代发信息</p>
                <ul class="behalfInfoDetail-wrap" id="behalf_detail_info">
                    <!--{foreach from=$behalfs item=behalf_info name=behalf_fee}-->
                    <li class="behalfInfoDetail behalf_info_{$behalf_info.bh_id} {if !$smarty.foreach.behalf_fee.first}hidden{/if}">
                        <p class="infomation">
                            <span>联系方式：</span>
                            <span>
                                {$behalf_info.bh_name|escape},
                                {$behalf_info.bh_tel|escape},
                                <!--{if $behalf_info.bh_ww}-->
                                <a title="与{$behalf_info.bh_name}店主交谈" href="http://amos.im.alisoft.com/msg.aw?v=2&uid={$behalf_info.bh_ww|escape:url}&site=cntaobao&s=2&charset={$charset}" target="_blank"><img border="0" src="http://amos.im.alisoft.com/online.aw?v=2&uid={$behalf_info.bh_ww|escape:url}&site=cntaobao&s=2&charset={$charset}" alt="与{$behalf_info.bh_name}店主交谈" align="absmiddle"/></a>
                                <!--{/if}-->
                                <!--{if $behalf_info.bh_qq}-->
                                    {imqq uin=$behalf_info.bh_qq&site=$behalf_info.bh_name|escape:url}                      
                                <!--{/if}-->
                            </span>
                        </p>
                        <p class="infomation">
                            <span>退货地址：</span>
                            <span>
                               {$behalf_info.owner_name|escape|default:姓名未填},
                               &nbsp;&nbsp;{$behalf_info.bh_tel|escape}&nbsp;&nbsp;{$behalf_info.region_name|escape}&nbsp;&nbsp;{$behalf_info.bh_address|escape}&nbsp;&nbsp;{$lang.zipcode}:{$behalf_info.zipcode|escape}
                            </span>
                        </p>
                        <!--{if $behalf_info.bh_notice}-->
                        <p class="f40"><font color=red>{$lang.emerge_notice}{$lang.colon}</font> {$behalf_info.bh_notice|escape}</p>
                        <!--{/if}-->
                    </li>
                    <!--{/foreach}--> 
                </ul>
            </section>
            <!-- 代发须知 -->
            <section class="behalfInfo">
                <p class="title">代发须知</p>

                <ul class="behalfInfoDetail-wrap" id="behalf_detail_info" style="margin-top:-15px;">
                    <li class="behalfInfoDetail">
                        {$lang.no_behalf_fee_data1}
                    </li>
                </ul>
            </section>
            <!--{/if}-->
        </div>

        <!-- 确认订单信息 -->
        <div class="o-box">
            <div class="o-box-t">
                确定订单信息
            </div>
            <div class="o-box-main">
                <div class="order-detail-list" id="orderDetail">
                    <table class="tb-order tb-order-detail">
                        <thead>
                        <tr>
                            <th class="detail-col">商品</th>
                            <th class="price-col">单价</th>
                            <th class="count-col">数量</th>
                            <th class="amount-col">小计</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!--{foreach from=$goods_info.items item=goods name=fe_goods}-->
                        <tr class="tr-tb j-order">
                            <td>
                                <dl class="order-item first clearfix">
                                    <dt class="detail-col">
                                        <div class="pic">
                                            <a href="/item/4967435" target="_blank">
                                                <img src="{$goods.goods_image}"
                                                     view-src="{$goods.goods_image}"
                                                     class="j-img-view" alt="" width="70">
                                            </a>
                                        </div>
                                        <div class="info">
                                            <div class="info-title">
                                                <a href="/item/5114550" target="_blank">{$goods.goods_name|escape}</a>
                                            </div>
                                            <!-- <div class="info-art-no">1154#</div> -->
                                            <span class="info-shop">{$goods_info.store_name|escape}</span>
                                        </div>
                                        <div class="sku" style="padding-left:20px;">

                                            <div class="sku-color">{$goods.specification|escape}</div>


                                            <div class="sku-size">尺码：均码</div>

                                        </div>
                                        <div class="clear"></div>
                                    </dt>
                                </dl>
                            </td>
                            <td class="price-col">
                                <span class="yuan"><em>{$goods.price|price}</em></span>
                            </td>
                            <td class="count-col">
                                {$goods.quantity}

                                <!--<p class="count-tip">已拿1件，缺货1件</p>-->
                            </td>
                            <td class="amount-col red">
                                <span class="yuan"><em>{$goods.subtotal|price}</em></span>
                            </td>
                        </tr>
                        <!-- {/foreach} -->
                        <!-- 商品服务 -->
                        <tr class="tr-tb tr-tf">
                            <td colspan="4">
                                <!--{if $behalfs}-->
                                    {include file=order.goods.service.html}
                                 
                                <!--{/if}-->
                            </td>
                        </tr>

                        <tr>
                            <td height="50" colspan="3" class="clearfix" >
                                <span style="line-height: 50px;display:block;text-align:right;width:100%;" class="fl">商品总价：</span>
                            </td>
                            <td class="tc amount-col red">
                                <!-- <span class="yuan" style="margin-right: 3px;">¥</span><em class="j-exp-fee">0.00</em> -->
                                <span id="goods_price_amount" class="fs14 strong f90 inline-block text-left price j-exp-fee" style="width:80px;">&yen;</span>
                            </td>
                        </tr>
                        <tr>
                            <td height="50" colspan="3" class="clearfix" >
                                <span style="line-height: 50px;display:block;text-align:right;width:100%;" class="fl">运费总计：</span>
                            </td>
                            <td class="tc amount-col red">
                                <a href="/help/issue/daifa2.html" target="_blank"><i class="vvicon"></i></a>
                                <span id="delivery_price_amount" class="yuan j-exp-fee" style="margin-right: 3px;">&yen;</span>

                            </td>
                        </tr>
                         <tr class="tr-tb tr-tf">
                            <td colspan="3" style="border-bottom: none;line-height: 50px;text-align: right;" height="50">
                                <span style="margin-left:20px;">服务费：</span>
                            </td>
                            <td class="amount-col red" style="border-bottom:none;">
                                <a href="/help/issue/daifa2.html" target="_blank"><i class="vvicon"></i></a>
                                <span class="yuan" id="goods_service_amount">&yen;{$goods_info.behalf_fee|price}</span>
                            </td> 
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 结算 -->
        <div class="o-box o-foot">
            <div class="o-foot-count">
                应付总额：
                <em id="order_amount" class="j-total-price price" style="margin-left: -2px;">{$goods_info.amount|price}</em>
            </div>
            <div class="o-foot-protocol checked j-foot-checkbox">
                <span class="check-txt">阅读并接受<a id="theP" href="http://www1.vvic.com/user_agreement.html" target="_blank">《51网代发服务协议》</a></span>
                <i class="vvicon check-item "></i>
                <i class="vvicon uncheck-item"></i>
            </div>
            <div class="o-foot-btn">
                <a href="{url app=cart&store_id=$goods_info.store_id}" class="o-btn-back" vda="action|confirm|back_cart">返回购物车</a>
                <a id="submitOrderBtn" href="javascript:void($('#order_form').submit());" class="j-btn-submit">{$lang.shopping_step_three}</a>
                <span id="errorUp" style="display: none;"></span>
            </div>
        </div>

        <div class="clear"></div>
        <input type="hidden" name="gids" value="{$gids}">
    </form>
</div>






<!--{if $smarty.get.shipping_choice neq '1'}-->
<form action="{url app=order&amp;goods=cart&amp;store_id=$smarty.get.store_id&amp;shipping_choice=1}" method="post" id="seller_method_form">        
<!--{else}-->
<form action="{url app=order&amp;goods=cart&amp;store_id=$smarty.get.store_id}" method="post" id="seller_method_form">     
<!--{/if}-->
    <input type="hidden" name="gids" value="{$gids}">
    <input type="hidden" name="so" value="1">
</form>


<!-- 修改地址弹窗 -->
<div id="consignerAddressPopup" style="display:none;">
    <form  id="editAddress"   novalidate="novalidate">
        <fieldset class="o-address" style="padding: 20px 0;">
            <div class="item clearfix">
                <label><span>*</span>所在地区：</label>
                <div id="eidt_region">
                    <input type="hidden" name="region_id" value="" id="eidt_region_id" class="mls_id" />
                    <input type="hidden" name="region_name" value="" class="mls_names" id="eidt_region_name"/>
                    <select style="display:none" class="required" data-valid="isNonEmpty" date-tip = "" data-error="请选择地区">
                        <option value=''>请选择...</option>
                          <?php echo $this->html_options(array('options'=>$this->_var['regions'])); ?>
                    </select>
                </div>
            </div>

            <div class="item clearfix">
                <label><span class="">*</span>详细地址：</label>
                <span class="form_group">
                    <textarea name="address" id="eidt_address" class="required input-address j-input-address" name="address" value="" cols="30"
                          rows="10" data-valid="isNonEmpty" date-tip = "" data-error="请填写详细地址"></textarea>
                </span>
                
            </div>
            <div class="item clearfix">
                <label><span>*</span>收货人：</label>
                <span class="form_group">
                    <input type="text" name="consignee" id="eidt_consignee" class="required" data-valid="isNonEmpty" data-tip="" data-error="请填写收货人" value="">
                </span>
                
                <span class="desc"><span class="red">注：</span>请填写真实姓名，否则部分快递拒绝收件</span>
            </div>
            <div class="item clearfix">
                <label><span>*</span>手机号码：</label>
                <span class="form_group">
                    <input type="text" name="phone_mob" id="eidt_mobile"  value=""  class="input-mobile required" placeholder="手机号码"
                    data-valid="isNonEmpty||isMobile" date-tip = "请输入您的手机号码" data-error="请输入您的手机号码||请输入合法手机号码">
                     <label class="label-tel">固定号码：</label>
                
                    <input type="text" name="phone_tel" id="eidt_tel" class="input-tel j-tels j-tel-1" placeholder="固定电话号码" value="" style="width:100px;">
                </span>
            </div>
            <div class="item clearfix mt10">
                <label>&nbsp;</label>
                <input type="button" style="width:90px;margin-left:80px;font-size:12px;height: 30px;" class="btn btn-default" value="取消" name="cancel" id="cancelSetConsignor">
                <input type="button" style="width:90px;margin-left: 10px;font-size:12px;height: 30px;" class="btn btn-primary" value="提交"  id="sureSetConsignor">
               
            </div>
            <div class="clear"></div> 
        </fieldset>
    </form>
</div>



{include file=footer2017.html}
<script>
    //选择填写地址或者常用地址
    var $addressForm = $('#address_form'),
        $addChoseBtn = $('#confirmOrder .o-box-t'),
        $writeNewAddres = $('#confirmOrder .writeNewAddres'),
        $witeNewAddWrap = $writeNewAddres.find('#witeNewAddWrap'),
        $usedAddress = $('#confirmOrder .usedAddress'),
        addChoseBtnType = 'add';//填写地址栏默认打开
    //地址选择    
    $addChoseBtn.on('click',function(){
        var $this = $(this);
        addChoseBtnType = $this.attr('data-type');
        if(addChoseBtnType == 'add'){//填写地址
            $this.addClass('selected').parents('.newsAddress').next('.used').find('.o-box-t').removeClass('selected');
            $writeNewAddres.slideDown(300).parents().find($usedAddress).slideUp(300);
            
        }else if(addChoseBtnType == 'select'){//选择常用地址
            $this.addClass('selected').parents('.used').prev('.newsAddress').find('.o-box-t').removeClass('selected');
            $writeNewAddres.slideUp(300).parents().find($usedAddress).slideDown(300);
        }
    });
    //根据填写地址ajax改变快递费用
    $(function(){
        regionInit("region1");
        var $NewAddresDetail = $('#address');
        $NewAddresDetail.on('click',function(){
            var $selects = $('#region1').find('select')
            //alert($selects.length);
            if($selects.length<4){
                layer.open({
                    title: '温馨提醒',
                    content: '请完善地址选择'
                });
                return false;
            }else{
                var regionId = $('#region_id').val();
                var bh_id = 0;
                for (i=0; i<document.getElementsByName('behalf').length; i++){
                    if (document.getElementsByName('behalf')[i].checked == true){
                        bh_id = document.getElementsByName('behalf')[i].value;
                    }
                }
                //更换地址后异步更新快递
                $.ajax({
                    url:'index.php?app=order&act=get_deliverys_by_behalf2&ajax=1',
                    data:{region_id:regionId,gids:'{$gids}',id:bh_id,quantity:goods_quantity},
                    type:'post',
                    success:function(data){
                        console.log('请求成功12');
                        //更换地址后,更新快递 
                        if(data != 'false'){
                            data = eval(data);
                            console.log(data);
                            var str_temp = "";
                            for(i=0;i<data.length;i++){
                                if(i == 0){
                                  str_temp = str_temp + "<label class='radio-wrap'><span class='radio-inner-wrap'><input type='radio' name='delivery' fee='"+data[i]['dl_fee']+"' value='"+ data[i]['dl_id'] + "' checked='checked'/><span class='radio-inner'></span></span><span class='text'>"+ data[i]['dl_name'] +"(<span class='price'>&yen;"+data[i]['dl_fee']+ "</span>)&nbsp;&nbsp;</span></label>";
                                }else{
                                    str_temp = str_temp + "<label class='radio-wrap'><span class='radio-inner-wrap'><input type='radio' name='delivery' fee='"+data[i]['dl_fee']+"' value='"+ data[i]['dl_id'] + "'/><span class='radio-inner'></span></span><span class='text'>"+ data[i]['dl_name'] +"(<span class='price'>&yen;"+data[i]['dl_fee']+ "</span>)&nbsp;&nbsp;</span></label";
                                }
                            } 
                                                        
                            $("#delivery_area").html(str_temp);                     
                            behalf_delivery_amount = parseInt($("input[type='radio'][name='delivery'][checked='checked']").attr('fee'));
                            
                            set_order_amount();
                            $('#delivery_price_amount').html(price_format(behalf_delivery_amount));
                        }else{
                            $("#delivery_area").html(); 
                        }
                        
                    },
                    error:function(){
                        alert('请求失败')
                    }
                })
            }
        })
    });


    //常用地址选择动态给父级添加selected
    var $radioCheck = $('.usedAddress .radioCheck');
       
    $radioCheck.on('click',function(){
        var $this = $(this),
            $parents = $this.parents('.address_item'),
            $regionId = $('#region_id'),
            $regionName = $('#region_name'),//省市区
            $address = $('#address'),//详细地址
            $consignee = $('#consignee'),//收货人姓名
            $mobile = $('#phone_mob'),//收货人手机号
            $tel1 = $('#phone_tel');//收货人固话

        if($radioCheck.is(':checked')){
           $this.parents('li').addClass('selected_address').siblings().removeClass('selected_address');
        }

        var behalf_id = getBh_id();
        //更新快递费用函数调用
        updateShip($this.val(),behalf_id,'index.php?app=order&act=get_deliverys_by_behalf&ajax=1');
        
        set_address();
        var addr_id = $("input[name='address_options']:checked").val();
        //fill_logist_fee_by_address(addr_id);
    })

    //获取当前选中的代发
    function getBh_id(){
        var bh_id = 0;
        for (i=0; i<document.getElementsByName('behalf').length; i++){
            if (document.getElementsByName('behalf')[i].checked == true){
                bh_id = document.getElementsByName('behalf')[i].value;
            }
        }
        return bh_id;
    }

    //更新快递费用函数
    function updateShip(addressId,hbId,$url){
        $.ajax({
            url:$url,
            data:{address_id:addressId,gids:'{$gids}',id:hbId,quantity:goods_quantity},
            type:'post',
            success:function(data){
                console.log('请求成功');
                //更换地址后,更新快递 
                if(data != 'false'){
                    data = eval(data);
                    var str_temp = "";
                    for(i=0;i<data.length;i++){
                        if(i == 0){
                          str_temp = str_temp + "<label class='radio-wrap'><span class='radio-inner-wrap'><input type='radio' name='delivery' fee='"+data[i]['dl_fee']+"' value='"+ data[i]['dl_id'] + "' checked='checked'/><span class='radio-inner'></span></span><span class='text'>"+ data[i]['dl_name'] +"(<span class='price'>&yen;"+data[i]['dl_fee']+ "</span>)&nbsp;&nbsp;</span></label>";
                        }else{
                            str_temp = str_temp + "<label class='radio-wrap'><span class='radio-inner-wrap'><input type='radio' name='delivery' fee='"+data[i]['dl_fee']+"' value='"+ data[i]['dl_id'] + "'/><span class='radio-inner'></span></span><span class='text'>"+ data[i]['dl_name'] +"(<span class='price'>&yen;"+data[i]['dl_fee']+ "</span>)&nbsp;&nbsp;</span></label";
                        }
                    } 
                                                
                    $("#delivery_area").html(str_temp);                     
                    behalf_delivery_amount = parseInt($("input[type='radio'][name='delivery'][checked='checked']").attr('fee'));
                    
                    set_order_amount();
                    $('#delivery_price_amount').html(price_format(behalf_delivery_amount));

                }else{
                    $("#delivery_area").html(); 
                }
                
            },
            error:function(){
                alert('请求失败')
            }
        })
    }


    //设置地址
    function set_address(){
        var addr_id = $("input[name='address_options']:checked").val();
        if(addr_id == 0){
            $('#consignee').val("");
            $('#region_name').val("");
            $('#region_id').val("");
            $('#address').val("");
            $('#tel1').val("");
            $('#mobile').val("");
        }else{

            fill_address_form(addr_id);
        }
    }
    //动态填充地址
    function fill_address_form(addr_id){
        var addr_data = addresses[addr_id];
        for(k in addr_data){
            switch(k){
                case 'consignee':
                    $("#consignee").val(addr_data[k]);
                    $("#eidt_consignee").val(addr_data[k]);
                    break;
                case 'address':
                    $("#address").val(addr_data[k]);
                    $("#eidt_address").val(addr_data[k]);
                    break;
                case 'phone_tel':
                    $("#tel1").val(addr_data[k]);
                    $("#eidt_tel1").val(addr_data[k]);
                    break;
                case 'phone_mob':
                    $("#mobile").val(addr_data[k]);
                    $("#eidt_mobile").val(addr_data[k]);
                    break;
                case 'region_id':
                    $('#region_id').val(addr_data[k]);
                    $('#eidt_region_id').val(addr_data[k]);
                    break;
                case 'region_name':
                    //动态填充地址
                    var $addressdetail = $('#region_name');
                    $addressdetail.val(addr_data[k]);
                    var detailParts = $addressdetail.val().split(' ');
                    var index = 0;
                    var next = function() {
                        var text = detailParts[index];
                        var $nextSelect = $('div#region1 select:eq(' + index + ') option:contains("' + text + '")');
                        if ($nextSelect.length === 0) {
                            $nextSelect = $('div#region1 select:eq(' + index + ') option:contains("' + text.substr(0, text.length-1) + '")');
                        }
                        if ($nextSelect.length > 0) {
                            $nextSelect.attr('selected', true);
                            $('div#region1 select:eq(' + index + ')').change();
                            index += 1;
                        }
                        if (index < detailParts.length) {
                            setTimeout(next, 500);
                        }
                    }
                    next();
                break;
            }
        }
    }

    //表单验证
    $addressForm.validate({
        onFocus:function(){
            return false;
        },
        onBlur:function(){
            var _status = parseInt(this.attr('data-status'));
            if(!_status){
                $(this).addClass('error');
            }
            return false;
        }
    });

    //确认订单是先进行表单验证
    $('#submitOrderBtn').on('click',function(event){
        var $this = $(this);
        //判定当前是选择常用地址还是手动新增地址
        if(addChoseBtnType == 'add' && $addChoseBtn.hasClass('selected')){
           if(!$addressForm.validate('submitValidate')){
                layer.open({
                    title: '温馨提醒',
                    content: '选择地址或者填写新收货地址~~'
                });  
                return false;
            }
        }else if(addChoseBtnType == 'select' && $addChoseBtn.hasClass('selected')){
            console.log('使用常用地址')
        }
        
    })


    //选择代发 //异步获取快递方式
    $('.behalfChose .radio-wrap .radio-inner-wrap input[name="behalf"]').on('click',function(){
        var $this = $(this),
            index = $(this).parents('.radio-wrap').index(),
            $behalfInfoLi = $('.behalfInfo #behalf_detail_info .behalfInfoDetail'),
            address_id = 0;//地址id
        if($this.attr('checked')){
            $behalfInfoLi.eq(index).show().siblings().hide();
        }
        //获取地址id
        for (i=0; i<document.getElementsByName('address_options').length; i++){
            if (document.getElementsByName('address_options')[i].checked == true){
                address_id = document.getElementsByName('address_options')[i].value;
            }
        }
        $.ajax({
            url:'index.php?app=order&act=get_deliverys_by_behalf&ajax=1',
            data:{address_id:address_id,gids:'{$gids}',id:$(this).val(),quantity:goods_quantity},
            type:'post',
            success:function(data){
                console.log('请求成功');
                if(data != 'false'){
                    data = eval(data);
                    var str_temp = "";
                    for(i=0;i<data.length;i++){
                        if(i == 0){
                          str_temp = str_temp + "<label class='radio-wrap'><span class='radio-inner-wrap'><input type='radio' name='delivery' fee='"+data[i]['dl_fee']+"' value='"+ data[i]['dl_id'] + "' checked='checked'/><span class='radio-inner'></span></span><span class='text'>"+ data[i]['dl_name'] +"(<span class='price'>&yen;"+data[i]['dl_fee']+ "</span>)&nbsp;&nbsp;</span></label>";
                        }else{
                            str_temp = str_temp + "<label class='radio-wrap'><span class='radio-inner-wrap'><input type='radio' name='delivery' fee='"+data[i]['dl_fee']+"' value='"+ data[i]['dl_id'] + "'/><span class='radio-inner'></span></span><span class='text'>"+ data[i]['dl_name'] +"(<span class='price'>&yen;"+data[i]['dl_fee']+ "</span>)&nbsp;&nbsp;</span></label";
                        }
                    }
                    //$("#delivery_area").html();                               
                    $("#delivery_area").html(str_temp); 
                    behalf_delivery_amount = parseInt($("input[type='radio'][name='delivery'][checked='checked']").attr('fee'));
                    set_order_amount();
                    $('#delivery_price_amount').html(price_format(behalf_delivery_amount));
                }
                //$("#behalf_detail_info div").hide();
                //$(".behalf_info_"+$(this).val()).show();
                
            },
            error:function(){
                alert('请求失败')
            }
        })
    })

    <!--{if $smarty.get.shipping_choice == 1}-->
    var shippings = {$shippings}|| '';
    <!--{/if}-->
    var addresses = {$addresses};
    var goods_amount = {$goods_info.amount};
    var goods_quantity = {$goods_info.quantity};
    var behalf_amount = {$goods_info.behalf_fee};
    var elementary_quality_check_fee = {$goods_info.elementary_quality_check_fee};
    var secondary_quality_check_fee = {$goods_info.secondary_quality_check_fee};
    var tags_change_fee = {$goods_info.tags_change_fee};
    var packing_bag_change_fee = {$goods_info.packing_bag_change_fee};
    var behalf_delivery_amount = 0;
    var coupon_amount = 0;

    <!--{if $smarty.get.shipping_choice == 1}-->
        $('*[ectype="logist_fees"]').live('click', function(){
            fill_order_amount();
        });

        // psmb
        fill_order_amount();
    <!--{/if}-->

    // show goods_price_amount  tiq
    $('#goods_price_amount').html(price_format(goods_amount));
    
    
    <!--{if $smarty.get.shipping_choice != 1}-->
        behalf_delivery_amount = parseInt($("input[type='radio'][name='delivery']:checked").attr('fee'));
        $('#delivery_price_amount').html(price_format(behalf_delivery_amount));
        $('#goods_service_amount').html(price_format(behalf_amount + elementary_quality_check_fee));
        set_order_amount();
    <!--{/if}-->  
   
    
    $("input[type='radio'][name='delivery']").on('click',function(){
        //把代发的快递费用加入总费用 
        behalf_delivery_amount =  parseInt($(this).attr('fee'));
        $('#delivery_price_amount').html(price_format(behalf_delivery_amount));
        set_order_amount();
    });
    
   
    
    $("input[name='quality_check'],input[name='tag_change'],input[name='bag_change']").on('click',function(){
        $('#goods_service_amount').html(price_format(calc_goods_service_fees()));
        set_order_amount(); 
    });                 
     

    
    // 淘宝地址粘贴
    $('textarea[name=taobao_address]').change(function() {
        var addressParts = $(this).val().split('，');
        if (addressParts.length === 5 || addressParts.length === 4) {
            var consignee, phone_mob, phone_tel, zipcode, address, state, city, district;
            consignee = addressParts[0].trim();
            phone_mob = addressParts[1].trim();
            if (addressParts.length === 5) {
                phone_tel = addressParts[2].trim();
                detail = addressParts[3].trim();
                zipcode = addressParts[4].trim();
            } else {
                phone_tel = '';
                detail = addressParts[2].trim();
                zipcode = addressParts[3].trim();
            }
            $('input[name=consignee]').val(consignee);
            $('input[name=phone_mob]').val(phone_mob);
            $('input[name=phone_tel]').val(phone_tel);
            $('input[name=zipcode]').val(zipcode);

            var detailParts = detail.split(' ');
            var start = 0;
            if (addressParts.length === 5) {
                start = 1;
            }
            state = detailParts[start].trim();
            city = detailParts[start + 1].trim();
            if (detailParts.length > 3) {
                district = detailParts[start + 2].trim();
                address = detailParts.slice(start + 3).join(' ');
            } else {
                address = detailParts.slice(start + 2).join(' ');
            }

            $('input[name=address]').val(address);

            var addressArray = ['中国', state, city];
            if (district) {
                addressArray.push(district);
            }
            var index = 0;
            var next = function() {
                var text = addressArray[index];
                var $nextSelect = $('div#region1 select:eq(' + index + ') option:contains("' + text + '")');
                if ($nextSelect.length === 0) {
                    $nextSelect = $('div#region1 select:eq(' + index + ') option:contains("' + text.substr(0, text.length-1) + '")');
                }
                if ($nextSelect.length > 0) {
                    $nextSelect.attr('selected', true);
                    $('div#region1 select:eq(' + index + ')').change();
                    index += 1;
                }
                if (index < addressArray.length) {
                    setTimeout(next, 500);
                }
            }
            next();
        }
    });
   

    // psmb 根据不同的收货地址加载不同的运费情况
    function fill_logist_fee_by_address(addr_id){
        i=1;
        obj = $('div[ectype="logist_fees"]');
        obj.children().remove();
        shipping_data = shippings[addr_id];
        $.each(shipping_data,function(k,v){
            if(i++==1){ 
                checked="checked='checked'"
            }else { checked = '';}
            html = '<ul class="receive_add"><label><li><input style="width:45px; text-align:center" class="mb5" type="radio" name="logist_fees" value="'+k+':'+v.logist_fees+'" '+checked+ '/>'+v.name+'：'+price_format(v.logist_fees)+'</li></label></ul>';
            obj.append(html);
        });
        fill_order_amount();
    }
    // psmb 设置总费用
    function fill_order_amount(){
        //logist_fee = coupon_value = _amount = 0;
        logist_fee = 0;
        
        logist_info = $('div[ectype="logist_fees"]').find('input:checked').val();
        if(logist_info!='' && logist_info!=undefined){
            logist_info = logist_info.split(':');
            //logist_type = logist_info[0];
            logist_fee  = parseFloat(logist_info[1]);
            //alert(logist_type+':'+logist_fee);
        } else {
            logist_fee = 0;
        }
        behalf_delivery_amount = logist_fee;
        $('#delivery_price_amount').html(price_format(behalf_delivery_amount));
        set_order_amount();
        //_amount = price_format(parseFloat(goods_amount+logist_fee));
        //$("#order_amount").html(_amount);

    }               


    //计算订单总价
    function set_order_amount(){
        var total_yh = {$vip_info.total|default:0};                 
         var _amount  = goods_amount + calc_goods_service_fees() + parseInt(behalf_delivery_amount) - coupon_amount + total_yh;
         $('#order_amount').html(price_format(_amount));
    }

    //计算服务费
    function calc_goods_service_fees(){
        var total_fees = behalf_amount;
        
        if($("input[name='quality_check']:checked").val() == 1) 
            total_fees +=  elementary_quality_check_fee;
        else if($("input[name='quality_check']:checked").val() == 2)
            total_fees += secondary_quality_check_fee;
        
        if($("input[name='tag_change']").attr('checked'))
            total_fees += tags_change_fee;
        
        if($("input[name='bag_change'").attr('checked'))
            total_fees += packing_bag_change_fee;
            
        return total_fees;
    }


    //弹窗
    var $consignerAddressPopup = $('#consignerAddressPopup'),//收货人地址模板
        consigneeAddressPopupTemp = $('#consigneeAddressPopup').html();//发货人地址模板
    //填写收货地址  
    function showAddressSelect(dt){
        $(dt).next('dd').toggleClass('ordar')
    }

    
    //修改地址弹窗
 
        
    $('.address-edit').on('click',function(){
        var $this = $(this),
            $url = $this.attr('data-url'),
            $parents = $this.parents('.address_item'),
            $edidtRadioCheck = $parents.find('.radioCheck'),
            $address_consignee = $parents.find('.address_consignee'),
            $address_region_name = $parents.find('.address_region_name'),
            $address_address = $parents.find('.address_address'),
            $address_phone_mob = $parents.find('.address_phone_mob'),
            $address_phone_tel = $parents.find('.address_phone_tel');
        //console.log($url);
        layer.open({
            type: 1,
            title: '修改地址',
            skin: 'yourclass',
            btnAlign: 'l',
            anim:5,
            resize:false,
            area : ['580px' , '418px'],
            content: $consignerAddressPopup,
            success:function(){
                regionInit("eidt_region"); 
                var $editAddress = $('#editAddress');
                //表单验证
                $editAddress.validate({
                    onFocus:function(){
                        return false;
                    },
                    onBlur:function(){
                        var _status = parseInt(this.attr('data-status'));
                        if(!_status){
                            $(this).addClass('error');
                        }
                        return false;
                    }
                });
                //关闭弹窗
                $('#cancelSetConsignor').on('click',function(){
                    layer.closeAll();
                });
                //确定
                $('#sureSetConsignor').on('click',function(){
                    var $datas = $editAddress.serializeArray();
                    if(!$editAddress.validate('submitValidate')){
                        layer.open({
                            title: '温馨提醒',
                            content: '请按照提示填写'
                        });  
                        return false;
                    }else{
                        $.ajax({
                            url:$url,
                            data:$datas,
                            type:'post',
                            success:function(res){
                                //动态改变地址信息
                                for(var i=0; i<$datas.length;i++){
                                    switch($datas[i].name){
                                        case 'consignee':
                                            $address_consignee.text($datas[i].value);
                                            $('#consignee').val($datas[i].value);
                                            break;
                                        case 'address':
                                            $address_address.text($datas[i].value);
                                            $('#address').val($datas[i].value);
                                            break;
                                        case 'phone_mob':
                                            $address_phone_mob.text($datas[i].value);
                                            $('#phone_mob').val($datas[i].value);
                                            break;
                                        case 'phone_tel':
                                            $address_phone_tel.text($datas[i].value);
                                            $('#phone_tel').val($datas[i].value);
                                            break;
                                        case 'region_id':
                                            $edidtRadioCheck.val($datas[i].value);
                                            $('#region_id').val($datas[i].value);
                                        break;
                                        case 'region_name':
                                            $address_region_name.text($datas[i].value);
                                            $('#region_name').val($datas[i].value);
                                            //动态填充地址
                                            var detailParts = $address_region_name.text().split(' '),
                                                index = 0;
                                            var next = function() {
                                                var text = detailParts[index];
                                                console.log(text)
                                                var $nextSelect = $('div#region1 select:eq(' + index + ') option:contains("' + text + '")');
                                                if ($nextSelect.length === 0) {
                                                    $nextSelect = $('div#region1 select:eq(' + index + ') option:contains("' + text.substr(0, text.length-1) + '")');
                                                }
                                                if ($nextSelect.length > 0) {
                                                    $nextSelect.attr('selected', true);
                                                    $('div#region1 select:eq(' + index + ')').change();
                                                    index += 1;
                                                }
                                                
                                            }
                                            next();
                                        break;
                                    }
                                }
                                var Bh_id = getBh_id();

                                //更新快递费用函数调用
                                updateShip($('#region_id').val(),Bh_id,'index.php?app=order&act=get_deliverys_by_behalf&ajax=1');
                                //关闭弹窗
                                layer.closeAll();
                            }
                        });
                       
                    }
                })
            }
        });
       
    })


</script>